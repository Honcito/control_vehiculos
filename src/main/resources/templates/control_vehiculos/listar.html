<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{plantilla/template_user :: head}">
    <meta charset="UTF-8">
    <title>Control de Entrada/Salida de Vehículos</title>
    <link rel="stylesheet" th:href="@{/static/css/tablas.css}"/>
    <script th:src="@{/static/js/interactiveTable.js}"></script>
    <script src="https://code.jquery.com/jquery-3.6.9.min.js"></script>
  <style>
    .table th {
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    .table td {
      vertical-align: middle;
    }
    .btn-group {
      display: flex;
      align-items: center;
    }
    .btn-group .btn {
      margin-right: 5px;
    }
  </style>
</head>
<body>
<header th:replace="~{plantilla/template_user :: header}"></header>
<div class="container">
  <h1 class="mt-3" th:text="${titulo}">Control de Entrada/Salida de Vehículos</h1>

  <table class="table">
    <thead class="thead-dark">
    <tr>
      <th scope="col">MATRÍCULA</th>
      <th scope="col">EMPRESA</th>
      <th scope="col">FECHA/HORA SALIDA</th>
      <th scope="col">OBSERVACIONES</th>
      <th scope="col">FECHA/HORA ENTRADA</th>
      <th scope="col">ACCIONES</th>
    </tr>
    </thead>
      <tbody id="control_vehiculos-tbody">
      <tr th:each="controlVehiculo, rowStat : ${listadoControles}" th:index="${rowStat.index}">
          <td>
              <input type="text" class="matricula-input" th:value="${controlVehiculo.matricula}" th:attr="data-row-index=${rowStat.index}">
              <span class="error" style="color: red; display: none;">Matrícula no encontrada</span>
              <input type="hidden" class="cod-vehiculo" th:value="${controlVehiculo.cod_vehiculo}">
          </td>
          <td>
              <input type="text" class="empresa-input" th:value="${controlVehiculo.empresa}">
          </td>
          <td contenteditable="true" th:attr="data-id=${controlVehiculo.cod_control}" class="fecha-salida" th:text="${controlVehiculo.getFechaSalidaFormateada()}"></td>
          <td contenteditable="true" th:attr="data-id=${controlVehiculo.cod_control}" class="observaciones" th:text="${controlVehiculo.observaciones}"></td>
          <td contenteditable="true" th:attr="data-id=${controlVehiculo.cod_control}" class="fecha-entrada" th:text="${controlVehiculo.getFechaEntradaFormateada()}"></td>
          <td>
              <div class="btn-group">
                  <button onclick="actualizarFila(this)" class="btn btn-primary">Actualizar</button>
                  <button onclick="eliminarFila(this)" class="btn btn-danger">Eliminar</button>
              </div>
          </td>
      </tr>
      <!-- New row template for adding new entries -->
      <tr id="new-row">
          <td>
              <input type="text" class="matricula-input" data-row-index="new">
              <span class="error" style="color: red; display: none;">Matrícula no encontrada</span>
              <input type="hidden" class="cod-vehiculo">
          </td>
          <td>
              <input type="text" class="empresa-input">
          </td>
          <td contenteditable="true" class="new-control fecha-salida"></td>
          <td contenteditable="true" class="new-control observaciones"></td>
          <td contenteditable="true" class="new-control fecha-entrada"></td>
          <td>
              <div class="btn-group">
                  <button onclick="guardarFila(this)" class="btn btn-primary">Guardar</button>
                  <button onclick="eliminarFila(this)" class="btn btn-danger">Eliminar</button>
              </div>
          </td>
      </tr>
      </tbody>
  </table>
</div>
<div class="container">
    <div style="margin-bottom: 100px;"></div>
</div>
<footer th:replace="~{plantilla/template_user :: footer}"></footer>

<script>
    // Asegura que sea una fecha válida
    function isValidDate(d) {
        return d instanceof Date &&!isNaN(d);
    }

    // Cambiar fecha al formato deseado YYYY-MM-DD HH:mm:ss.
    function formatDate(date) {
        let day =("0" + date.getDay()).slice(-2);
        let month = ("0" + (date.getMonth() + 1)).slice(-2);
        let year = date.getFullYear();
        let hours = ("0" + date.getHours()).slice(-2);
        let minutes = ("0" + date.getMinutes()).slice(-2);
        let seconds = ("0" + date.getSeconds()).slice(-2);
        return year + "-" + month + "-" + day + " " + hours + ":" + minutes + ":" + seconds;
    }

    // Actualizar la fila con la fecha actual al hacer click en la celda
    function actualizarFila(button) {
        let fila = $(button).closest('tr');
        let id = fila.find('[data-id]').attr('data-id');
        let matricula = fila.find('[.matricula-input').val();
        let codVehiculo = fila.find('[.cod-vehicula]').val();
        let empresa = fila.find('[.empresa-input').val();
        let fechaSalida = fila.find('[.fecha-salida]').text().trim();
        let observaciones = fila.find('[.observaciones]').text().trim();
        let fechaEntrada = fila.find('[.fecha-entrada]').text().trim();

        // Convertir las fechas a formato ISO si no están vacías y son válidas
        let fechaSalidaIso = null;
        let fechaEntradaIso = null;

        if (fechaSalida) {
            let parsedFechaSalida = new Date(Date.parse(fechaSalida));
            if (isValidDate(parsedFechaSalida)) {
                fechaSalidaIso = parsedFechaSalida.toISOString();
            }
        }

        if (fechaEntrada) {
            let parsedFechaEntrada = new Date(Date.parse(fechaEntrada));
            if (isValidDate(parsedFechaEntrada)) {
                fechaEntradaIso = parsedFechaEntrada.toISOString();
            }
        }

        let url = '/control_vehiculos/actualizar/' + id;

        let data = {
            matricula: matricula,
            cod_vehiculo: codVehiculo,
            empresa: empresa,
            fecha_salida: fechaSalidaIso,
            observaciones: observaciones,
            fecha_entrada: fechaEntradaIso
        };

        // Verifico los datos en consola
        console.log("Datos enviados:", data);

        // Petición PUT
        $.ajax({
            url: url,
            type: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function (response) {
                console.log("Datos actualizados correctamente:", response);
                cargarListaControles(); // Recargar la lista después de actualizar
            },
            error: function (error) {
                console.error("Error al actualizar los datos:", error);
            }
        });
    }

    function guardarFila(button) {
        let fila = $(button).closest('tr');
        let matricula = fila.find('[.matricula-input').val();
        let codVehiculo = fila.find('[.cod-vehicula]').val();
        let empresa = fila.find('[.empresa-input').val();
        let fechaSalida = fila.find('[.new-control.fecha-salida]').text().trim();
        let observaciones = fila.find('[.new-control.observaciones]').text().trim();
        let fechaEntrada = fila.find('[.new-control.fecha-entrada]').text().trim();

        // Convertir las fechas a formato ISO si no están vacías y son válidas
        let fechaSalidaISO = null;
        let fechaEntradaISO = null;

        // Validaciones de formato de fechas
        if (fechaSalida) {
            let parsedFechaSalida = new Date(Date.parse(fechaSalida));
            if (isValidDate(parsedFechaSalida)) {
                fechaSalidaISO = parsedFechaSalida.toISOString();
            }
        }

        if (fechaEntrada){
            let parsedFechaEntrada = new Date(Date.parse(fechaEntrada));
            if (isValidDate(parsedFechaEntrada)) {
                fechaEntradaISO = parsedFechaEntrada.toISOString();
            }
        }

        let url = '/control_vehiculos/guardar';

        let data = {
            matricula: matricula,
            cod_vehiculo: codVehiculo,
            empresa: empresa,
            fecha_salida: fechaSalidaISO,
            observaciones: observaciones,
            fecha_entrada: fechaEntradaISO
        };

        // Verificar los datos en consola del navegador
        console.log("Datos enviados:", data);

        // Petición POST
        $.ajax({
            url: url,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function (response) {
                console.log("Datos guardados correctamente:", response);
                cargarListaControles(); // Recargar la lista después de guardar
            },
            error: function (error) {
                console.error("Error al guardar los datos:", error);
            }
        });
    }

    function eliminarFila(button) {
        let fila = $(button).closest('tr');
        let id = fila.find('[data-id]').attr('data-id');

        let url = '/control_vehiculos/eliminar/' + id;

        // Petición DELETE
        $.ajax({
            url: url,
            type: 'DELETE',
            success: function (response) {
                console.log("Datos eliminados correctamente:", response);
                cargarListaControles(); // Recargar la lista después de eliminar
            },
            error: function (error) {
                console.error("Error al eliminar los datos:", error);
            }
        });
    }


</script>
</body>
</html>